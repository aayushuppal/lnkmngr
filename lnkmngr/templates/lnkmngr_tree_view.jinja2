<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>{{ title }}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/logo.png') }}" type="image/x-icon" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" />

    <script src="https://jsuites.net/v4/jsuites.js"></script>
    <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/lnkmngr.css') }}" />
</head>

<body class="container">
    <div class="pt-2">
        <h3>
            <a href="/" style="text-decoration:none;">
                <i class="fas fa-stream"></i>
            </a>
            {{ title }}
        </h3>
    </div>
    <hr/>

    <div class="d-flex justify-content-start">
        <div id="cat_1"></div>&nbsp;
        <div id="cat_2" style="pointer-events:none"></div>&nbsp;
        <input id="label" type="text" placeholder="label" style="width:300px" />&nbsp;

        <textarea  id="href" rows="2" cols="40" placeholder="href"></textarea>&nbsp;

        <button id="add_entry">
            <i id="add_lbt_btn" class="fas fa-plus-square"></i>
        </button>
    </div>
    <br/><br/>

    <input id="jstree_search" type="text" placeholder="search" style="width:300px" />
    &nbsp;|&nbsp;
    <button id="exa">
        <i id="exp_close_button" class="far fa-folder"></i>
    </button>
    &nbsp;|&nbsp;
    <button id="del">
        <i id="del_btn" class="far fa-trash-alt"></i>
    </button>
    &nbsp;|&nbsp;
    <button id="reorder_tree">
        <i class="fas fa-sitemap"></i>
    </button>
    &nbsp;|&nbsp;
    <input id="edit_label" type="text" style="width:300px" />&nbsp;
    <input id="edit_href" type="text" />&nbsp;
    <button id="edit_btn_id">
        <i class="fas fa-pen-square"></i>
    </button>

    <br/><br/>
    <div id="jstree"></div>

    <br/><br/>
    <script>
        var table_name = {{table_name|tojson}};
        var links_json={{links_json|tojson}};
        var g_selected_id = null;

        function createJSTree(links_data_json) {
            $('#jstree').jstree({
                'core': {
                    'check_callback': true,
                    'data': links_data_json,
                },
                "types": {
                    "category": {
                        "icon": "fas fa-folder"
                    },
                    "link": {
                        "icon": "fas fa-minus fa-xs"
                    },
                    "default": {
                        "icon": "fas fa-folder"
                    }
                },
                "plugins": ["themes", "json_data", "ui", "types", "search", "sort", "dnd"],
                'sort' : function(a, b) {
                    var node_a = this.get_node(a);
                    var node_b = this.get_node(b);
                    if (node_a.type == node_b.type) {
                        nat = node_a.text.toLowerCase();
                        nbt = node_b.text.toLowerCase();
                        return (nat < nbt) ? -1 : 1;
                    } else {
                        return (node_a.type == "link") ? -1 : 1;
                    }
                },
                'search': {
                    'case_insensitive': true,
                    'show_only_matches' : true,
                    'show_only_matches_children' : true,
                }
            }).on('open_node.jstree', function (e, data) {
                data.instance.set_icon(data.node, "fas fa-folder-open");
            }).on('close_node.jstree', function (e, data) {
                data.instance.set_icon(data.node, "fas fa-folder");
            });
        };

        createJSTree(links_json);

        $('#jstree_search').keyup(function(){
            $('#jstree').jstree(true).show_all();
            $('#jstree').jstree('search', $(this).val());
        });

        var selected_nodes = [];
        $('#jstree').on("changed.jstree", function (e, data) {
            selected_nodes = data.selected;
        });

        $('#jstree').bind("select_node.jstree", function (e, data) {
            var href = data.node.a_attr.href;
            node = data.node;
            g_selected_id = node.id;
            $("#edit_label").val(node.text);
            if (href != "#") {
                $("#edit_href").val(href);
            } else {
                $("#edit_href").val(null);
            }
        });

        var g_is_tree_expanded = false;
        $('#exa').on('click', function () {
            if (g_is_tree_expanded) {
                $("#jstree").jstree("close_all");
                $("#exp_close_button").attr("class", "far fa-folder-open");
                g_is_tree_expanded = false;
            } else {
                $("#jstree").jstree("open_all");
                $("#exp_close_button").attr("class", "far fa-folder");
                g_is_tree_expanded = true;
            }
        });

        $('#jstree').on('ready.jstree', function () {
            $('#exa').click();
        });

        $('#del').on('click', function () {
            $.ajax("/del_entries_route/", {
                data: JSON.stringify({
                    "table_name": table_name,
                    "ids": selected_nodes,
                }),
                contentType: 'application/json',
                type: 'POST',
            }).done(function (response) {
                location.reload(true);
            });
        });


        var all_cats = {{ all_cats }};
        var cat_map = {{ cat_map }};

        var g_d1 = jSuites.dropdown(document.getElementById('cat_1'), {
            data: all_cats,
            autocomplete: true,
            multiple: false,
            width: '200px',
            newOptions: true,
            success: function() {
                instance.setId(item, null);
            },
            onchange: function() {
                d1_val = g_d1.getValue();
                if (d1_val == "") {
                    g_d2.setData(all_cats);
                    $("#cat_2").attr("style", "pointer-events:none");
                } else {
                    x = cat_map[d1_val];
                    if (x == null || x.length == 0) {
                        g_d2.setData([{}]);
                    } else {
                        g_d2.setData(x);
                    }
                    $("#cat_2").attr("style", "pointer-events:all");
                }
            }
        });

        var g_d2 = jSuites.dropdown(document.getElementById('cat_2'), {
            data: [{}],
            autocomplete: true,
            multiple: false,
            width: '200px',
            newOptions: true,
            success: function() {
                instance.setId(item, null);
            }
        });

        $('#add_entry').on('click', function () {
            $.ajax("/add_new_entry_route/", {
                data: JSON.stringify({
                    "table_name": table_name,
                    "cat_1_id": g_d1.getValue(),
                    "cat_1_val": g_d1.getText(),
                    "cat_2_id": g_d2.getValue(),
                    "cat_2_val": g_d2.getText(),
                    "label": $("#label").val(),
                    "href": $("#href").val(),
                }),
                contentType: 'application/json',
                type: 'POST',
            }).done(function (response) {
                location.reload(true);
            });
        });

        $('#reorder_tree').on('click', function () {
            $.ajax("/reorder_tree_route/", {
                data: JSON.stringify({
                    "table_name": table_name,
                    "new_tree_json": $("#jstree").jstree(true).get_json('#', { 'flat': true }),
                }),
                contentType: 'application/json',
                type: 'POST',
            }).done(function (response) {
                location.reload(true);
            });
        });

        $('#edit_btn_id').on('click', function () {
            $.ajax("/edit_entry_route/", {
                data: JSON.stringify({
                    "table_name": table_name,
                    "id": g_selected_id,
                    "label": $("#edit_label").val(),
                    "href": $("#edit_href").val(),
                }),
                contentType: 'application/json',
                type: 'POST',
            }).done(function (response) {
                location.reload(true);
            });
        });

    </script>
</body>

</html>
